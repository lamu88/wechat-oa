<include file="Common:header" />
<script charset="utf-8" src="http://map.qq.com/api/js?v=2.exp&key=ZDTBZ-WHKHS-XOKOQ-6EF7Y-L3QMV-3BFHC"></script>
<script charset="utf-8" src="http://map.qq.com/api/js?v=2.exp&libraries=place"></script>
<!-- <script>
jQuery(function($){
    var ip = null;
    var url = 'http://chaxun.1616.net/s.php?type=ip&output=json&callback=?&_='+Math.random();  
    $.getJSON(url, function(data){
        ip = data.Ip;  
    });
});
</script> -->
 <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=2b79c282b0f365ca9782cceb499e6022"></script>
<script src="./Tpl/Qyapp/Static/Js/artTemplate/dist/template.js" type="text/javascript"></script>
<<script type="text/javascript" src="./Tpl/Qyapp/Public/Js/PCASClass.js" charset="utf-8"></script> 

<section class="hbox stretch">
	<aside class="aside-md bg-white b-r" id="subNav">
<!-- 		<div class="wrapper b-b header"><b>微信考勤</b></div>
		<ul class="nav">
		
			 <li class="b-b b-light open"><a href="{lanrain::U('Attendance/index',array('mid'=>$_GET['mid']))}" target="_self"><i class="fa fa-chevron-right pull-right m-t-xs text-xs icon-muted"></i>考勤设置</a></li>
			<li class="b-b b-light"><a href="{lanrain::U('Attendance/rule',array('mid'=>$_GET['mid']))}" target="_self"><i class="fa fa-chevron-right pull-right m-t-xs text-xs icon-muted"></i>考勤规则</a></li>
			<li class="b-b b-light"><a href="{lanrain::U('Attendance/address',array('mid'=>$_GET['mid']))}" target="_self"><i class="fa fa-chevron-right pull-right m-t-xs text-xs icon-muted"></i>考勤地点</a></li>
			<li class="b-b b-light"><a href="{lanrain::U('Attendance/tongji',array('mid'=>$_GET['mid']))}" target="_self"><i class="fa fa-chevron-right pull-right m-t-xs text-xs icon-muted"></i>考勤统计</a></li>
						
			<li class="b-b b-light"><a href="{lanrain::U('Menu/menu',array('mid'=>$_GET['mid']))}" target="_self"><i class="fa fa-chevron-right pull-right m-t-xs text-xs icon-muted"></i>自定义菜单</a></li>
			<li class="b-b b-light">
				<a href="{lanrain::U('Appmsg/conf',array('mid'=>$_GET['mid']))}" target="_self"><i class="fa fa-chevron-right pull-right m-t-xs text-xs icon-muted"></i>应用管理</a>
			</li>
			
		</ul> -->
<include file="Attendance:navmenu" />			
	</aside> 
    <aside>
		<section class="vbox">
			<header class="header bg-white b-b b-light">
				<p>新增考勤地点</p>
				<a class="text-muted pull-right m-t pointer" data-toggle="back" href="javascript:history.go(-1)" title="返回"><i class="fa fa-reply"></i></a>
			</header>
			<section class="scrollable  wrapper">
				<section class="panel panel-default">
					<div class="panel-body">
						<form class="form-horizontal form-validate" method="post" target="_self" action="{lanrain::U('Attendance/addadress',array('mid'=>$_GET['mid']))}"> 
					   <!-- <input type="hidden" value="{lanrain:$data.id}" name="id" aria-invalid="false"> -->

							<div class="form-group">
								<label class="col-sm-2 control-label must">考勤范围</label>
								<div class="col-sm-4">
									<div class="input-group">
									  <input class="form-control valid" type="text" value="{lanrain:$data.long}" name="range" id="range" aria-invalid="false">
									  <div class="input-group-addon">米</div>
									</div>
								</div>
								<div class="col-sm-5">
									<span class="help-block form-control-static">（该范围内员工可以签到/签退）</span>
								</div>
							</div>
						   <div class="form-group">
								<label class="col-sm-2 control-label">企业所在地</label>
								<div class="col-sm-10">
									<div class="form-inline" data-toggle="location">

										<div class="form-group ">
											<div class="col-lg-12">
												<select  class="text tip" name="province3" id="province" title="请选择"  style="min-height:30px;"></select>
											</div></div>
										<div class="form-group ">
											<div class="col-lg-12">
												<select  class="text tip" name="city3" id="city" title="请选择"  style="min-height:30px;"></select>
												</div>
										</div>
										<div class="form-group ">
											<div class="col-lg-12">
												<select  class="text tip" name="area3" id="area" title="请选择"  style="min-height:30px;"></select>
												</div>
										</div>
									</div>

								</div>
							</div>
					
							<div class="form-group">
								<label class="col-sm-2 control-label">考勤地点</label>
								<div class="col-sm-6">
									<div class="input-group col-sm-8 pull-left">
										<input type="text" class="form-control js_map_key valid" data-rule-required="true" id="address" name="address" value="" aria-required="true" aria-invalid="false">
										<span class="input-group-btn">
											<button class="btn btn-default js_map_search" type="button" onclick="codeAddress();">搜索</button>
										</span>
									</div> 
								</div>
									<!--  <div class="col-sm-4">
										<span class="help-block form-control-static">（这个只是模糊定位，准确位置请地图上标注!）</span>
									</div>	 --> 				
							</div>
                            <!-- <input type="hidden" class="form-control js_map_key valid" id="address" name="address" value=""> -->
							<div class="form-group">
								<label class="col-sm-2 control-label must">地图标注</label>
								<div class="col-sm-10 js_map">
									<div class="clearfix">
										<div class="maroon pull-left m-t-sm">注意：请将准确位置在地图上标注，否则无法签到或签退!</div>
									</div>
									<div class="map_container js_map_container" style="overflow: hidden; position: relative; z-index: 0; color: rgb(0, 0, 0); text-align: left; background-color: rgb(243, 241, 236);" id="container">
									</div>
									<div class="col-sm-12">
										<div class="form-inline">
											<div class="form-group">
												<input type="text" class="form-control js_map_lat" readonly="readonly" data-rule-required="true" name="lng" id="point_x" value="{lanrain:$data.longitude}" aria-required="true">
											</div> 
											<div class="form-group">
												<input type="text" class="form-control js_map_lng" readonly="readonly" data-rule-required="true" name="lat"  id="point_y" onblur="geolocation_latlng()" value="{lanrain:$data.latitude}" aria-required="true">
											</div>
											<span style="height:30px;display:none" id="city"></span> 
										</div>
									</div>

								</div>
							</div>					
						
							<div class="form-group">
								<div class="col-sm-4 col-sm-offset-2">
									<input type="hidden" name="method" id="method" />
									<button type="submit" data-toggle="method" data-method="release" class="btn btn-primary" data-confirm="false" data-loading-text="保存中...">保存</button>
								</div>
							</div>
						</form>					
					</div>
				</section>
			</section>
		</section>
	</aside>
    </section>	
	<!-- JZSBZ-ZI4RF-HRCJY-JN3OW-V37KS-SOB4K -->
<script language="javascript">
new PCAS("province3","city3","area3");
</script> 
<script>
 $("#province").val("{lanrain:$data.province}");
 $("#city").val("{lanrain:$data.city}");
 $("#area").val("{lanrain:$data.area}");
$(function(){
  $("#submit").click(function() {
    var range = $("#range").val();
	var province = $("#province").val();
	var city = $("#city").val();
	var area = $("#area").val();
	var address = $("#address").val();
	var longitude = $("#longitude").val();
	var latitude = $("#latitude").val();
	$.ajax({
			type: "post",  
			url:"{lanrain::U('Attendance/editadress')}",
			dataType:'json',
			data:'long='+range+'&province='+province+'&city='+city+'&area='+area+'&address='+address+'&longitude='+longitude+'&latitude='+latitude+'&id={lanrain:$data.id}',
			success:function(json){
				var status = json.status;
				if(status==0){
					alert('设置成功');
					window.location.reload();
				}else{
					alert('设置失败');
				}

			}
		});
  });
  
})
</script> 	
<script src="http://pv.sohu.com/cityjson?ie=utf-8"></script>  
    <script type="text/javascript">
        var geocoder, map, marker, address, ip, citylocation = null;		
		ip = returnCitySN["cip"];
		address = returnCitySN["cname"];
		document.getElementById("address").value = address;

		var center = new qq.maps.LatLng(39.916527,116.397128);
		var map = new qq.maps.Map(document.getElementById('container'),{
			center: center,
			zoom: 12
		});
		var info = new qq.maps.InfoWindow({
			map: map
		});			
		geocoder = new qq.maps.Geocoder();
		geocoder.getLocation(address);
		//设置服务请求成功的回调函数
		geocoder.setComplete(function(result) {
			map.setCenter(result.detail.location);
			    marker = new qq.maps.Marker({
				map: map,
				position: result.detail.location
			});
			info.open();
			info.setContent('<div style="text-align:center;white-space:nowrap;' +
				'margin:10px;">'+result.detail.address+'</div>');
			info.setPosition(marker.getPosition());			
			marker.setVisible(true);			
			marker.setDraggable(true);	
			marker.setTitle("拖动标注到你想要的位置");	          			
			qq.maps.event.addListener(marker, 'dragend', function(e) {		
				var newPosition = marker.getPosition();
				geocoder.getAddress(newPosition);
				geocoder.setComplete(function(result) {
					info.open();
					info.setContent('<div style="text-align:center;white-space:nowrap;' +
						'margin:10px;">'+result.detail.address+'</div>');
					info.setPosition(marker.getPosition());	
					$('#address').attr('value',result.detail.address);				
				});
				maddress = e.latLng.toString();
				var mlatlngStr = maddress.split(",",2);
				var mlat = parseFloat(mlatlngStr[0]);
				var mlng = parseFloat(mlatlngStr[1]);			
				document.getElementById("point_x").value = mlat;
				document.getElementById("point_y").value = mlng;			
			});				
		});		
		function codeAddress() {
			var naddress = document.getElementById("address").value;
			//对指定地址进行解析
			geocoder.getLocation(naddress);
			
		    //设置服务请求成功的回调函数
			geocoder.setComplete(function(result) {
				if (marker != null) {
					marker.setMap(null);
				}				
				map.setCenter(result.detail.location);			
				    marker = new qq.maps.Marker({
					map: map,
					position: result.detail.location
				});
				info.open();
				info.setContent('<div style="text-align:center;white-space:nowrap;' +
					'margin:10px;">'+result.detail.address+'</div>');
				info.setPosition(marker.getPosition());	
				document.getElementById("point_x").value = result.detail.location.lat;
				document.getElementById("point_y").value = result.detail.location.lng;               				
				marker.setVisible(true);			
				marker.setDraggable(true);	
				marker.setTitle("拖动标注到你想要的位置");	 				
				qq.maps.event.addListener(marker, 'dragend', function(e) {		
					var newPosition = marker.getPosition();
					geocoder.getAddress(newPosition);
					geocoder.setComplete(function(result) {
						info.open();
						info.setContent('<div style="text-align:center;white-space:nowrap;' +
							'margin:10px;">'+result.detail.address+'</div>');
						info.setPosition(marker.getPosition());	
						$('#address').attr('value',result.detail.address);				
					});
					laddress = e.latLng.toString();
					var mlatlngStr = laddress.split(",",2);
					var mlat = parseFloat(mlatlngStr[0]);
					var mlng = parseFloat(mlatlngStr[1]);			
					document.getElementById("point_x").value = mlat;
					document.getElementById("point_y").value = mlng;			
				});				
			});			
		}
		
    </script>
<include file="Common:footer" />