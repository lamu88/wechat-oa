
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"/>
<title>外勤详情</title>
<link rel="stylesheet" href="./Tpl/Qyapp/Legwork/css/style1.css">
<link rel="stylesheet" href="./Tpl/Qyapp/Legwork/css/kaoqin.css">
<link rel="stylesheet" href="./Tpl/Qyapp/Applyflow/css/date.css">
<link rel="stylesheet" type="text/css" href="./Tpl/Qyapp/Applyflow/css/btm.css?v=1438078926">	
<script src="./Tpl/Qyapp/Legwork/js/lanrenzhijia.js"></script>
<script src="./Tpl/Qyapp/Static/Js/jquery-1.9.1.min.js" type="text/javascript"></script>
</head>
<body class="bg1" onload="init()">
<section class="top" >
<if condition="$_GET['check'] eq 1">
<ul style="">
<li style="width:25%;">
<if condition="$touser['pic']"><img src="{lanrain:$touser.pic}" width="72px" height="72px" style="border-radius:10px;"><else/><img src="./Tpl/Qyapp/Applyflow/images/que.png" width="72px" height="72px" style="border-radius:10px;"></if>	 </li>
<li style="width:53%;margin-left:2%">
<p class="top-p">出勤人:<span style="font-size:24px;">{lanrain:$touser.name}</span></p>
<p class="top-p">职务:{lanrain:$touser.position}</p>
<p class="top-p">部门:{lanrain:$touser.department}</p>	
</li>
<li style="width:20%;text-align:center;padding-top:10px;position:relative;" tel=""><!-- tel:123456789 -->
<a href="tel:{lanrain:$touser.mobile}">
<img src="./Tpl/Qyapp/Applyflow/images/phone.png" width="50px" height="50px">
</a>
</li>	
</ul>
<else/>
<ul style="">
<li style="width:25%;">
<if condition="$users['pic']"><img src="{lanrain:$users.pic}" width="72px" height="72px" style="border-radius:10px;"><else/><img src="./Tpl/Qyapp/Applyflow/images/que.png" width="72px" height="72px" style="border-radius:10px;"></if>	 </li>
<li style="width:53%;margin-left:2%">
<p class="top-p">发起:<span style="font-size:24px;">{lanrain:$users.name}</span></p>
<p class="top-p">职务:{lanrain:$users.position}</p>
<p class="top-p">部门:{lanrain:$users.department}</p>	
</li>
<li style="width:20%;text-align:center;padding-top:10px;position:relative;" tel=""><!-- tel:123456789 -->
<a href="tel:{lanrain:$users.mobile}">
<img src="./Tpl/Qyapp/Applyflow/images/phone.png" width="50px" height="50px">
</a>
</li>	
</ul>
</if>
</section>
<section class="sec03-02">
<section class="sec03-02">
<section class="sec03-02">
<article class="leg_cont">

	<section class="sec02-01">
		<div class="lanrenzhijia">
		<ul id="nav_dot">
		<li class="leg_zhe">
		<h4 class="item-span"></h4>
		<div class="list-item none">

		<ul class="task_info">
		<li>
		<span class="item-span tj_tt">类型</span>
		<span class="span">{lanrain:$list3.outstyle}</span>
		</li>
		<li>
		<span class="item-span tj_tt">日期</span>
		<span class="span">{lanrain:$list3.btime|date="Y.m.d",###}-{lanrain:$list3.btime|date="Y.m.d",###}</span>
		</li>
		<li>
		<span class="item-span tj_tt">地点</span>
		<span class="span">{lanrain:$list3.outplace}</span>
		</li>
		</ul>
		<div class="con">
		<div class="txt fl">
		<span class="item-span tj_tts">内容</span>
		<p>{lanrain:$list3.outaim}</p>
		</div>
		</div>
		</div>
		</li>
		</ul>
		</div>

		<script>
		navList(12);
		</script>
		<if condition="$_GET['check'] neq 1">
		<div class="button-w submit"><input type="button" id="submitImging" value="签到"/></div>
		</if>
	</section>
</article>
</section>

</section>

</section>
<!--图库弹出层 开始-->
<div class="mskeLayBg"></div>
<div class="mskelayBox">
  <div class="mske_html">
  </div>
  <div class="mskeClaose"></div>
</div>
<!--图库弹出层 结束-->
<div class="check-mid" id="list">
<span class="shuxian"></span>
<input type="hidden" id="pic" name="pic" value="" />
<input type="hidden" id="pic1" name="pic1" value="" />
<input type="hidden" id="longitude" name="longitude" value=""/>
<input type="hidden" id="latitude" name="latitude" value=""/>
<input type="hidden" id="place" name="place" value=""/>
<input type="hidden" id="desc" name="desc" value=""/>
<input type="hidden" id="key_2" value="{lanrain:$list.place}" />
<volist name="list" id="list">

<div id="on">
<div class="check-content">
<div class="circle">{lanrain:$list.checktime|date="H:i",###}</div>

<div class="qiandao">
<div class="arrow-left"></div>
<a href="http://apis.map.qq.com/uri/v1/geocoder?coord={lanrain:$list.lat},{lanrain:$list.long}">
<div class="time-address">{lanrain:$list.desc}<span><img src="./Tpl/Qyapp/Legwork/images/map_jiaoyu.png" width="13px" height="13px"/>{lanrain:$list.place}</span></div>
</a>
<!--签到图片-->
<div class="msKeimgBox">
 <div>
      <img src="./Tpl/Qyapp/Legwork/images/waiqin.png" class="qiandao_pic"/>
      <span class="hidden">
      <img src="{lanrain:$list.img}" width="100%" />
      </span>
</div>
</div>
</div>
</a>
</div>
</div>
</volist>
</div>




<style>
#menu{position:fixed;bottom:0px;width:95%;height:36px;line-height:36px;background:#fff;z-index:999;margin-left:3%;padding-bottom: 10px;}
#menu ul li{float:left;width:49%;height:100%;text-align:center;position:relative;font-size:14px;border-radius: 3px;}
#menu ul li .menu_li{position:absolute;top:0px;left:0px;z-index:20;width:100%;height:100%;color:#fff;}
a{text-decoration:none;}
</style>
<input type="text" id="txt_serverID" style="display:none" />
<input type="text" id="mylistice" name="listice" style="display:none" />
<input type="hidden" id="token" value="yCmsgL1437570237"></input>
<script src="./Tpl/Qyapp/Applyflow/js/jquery.js"></script>
<script src="./Tpl/Qyapp/Applyflow/js/main.js"></script>
<script src="http://g.alicdn.com/ilw/ding/0.2.7/scripts/dingtalk.js"></script>
<script language="javascript" src="http://webapi.amap.com/maps?v=1.3&key=caaa086bdf5666322fba3baf5a6a2c03"></script>
<!-- <script src="Tpl/Qyapp/Applyflow/js/main.js"></script> -->
<script language="javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script src="http://pv.sohu.com/cityjson?ie=utf-8"></script> 
<script charset="utf-8" src="http://map.qq.com/api/js?v=2.exp"></script>
<script type="text/javascript">
jQuery(function(){
//图库弹出层
$(".mskeLayBg").height($(document).height());
$(".mskeClaose").click(function(){$(".mskeLayBg,.mskelayBox").hide()});
$(".msKeimgBox div").click(function(){$(".mske_html").html($(this).find(".hidden").html());$(".mskeLayBg").show();$(".mskelayBox").fadeIn(300)});
$(".mskeTogBtn").click(function(){$(".msKeimgBox").toggleClass("msKeimgBox2");$(this).toggleClass("mskeTogBtn2")});

});
//屏蔽页面错误
jQuery(window).error(function(){
  return true;
});
jQuery("img").error(function(){
  $(this).hide();
});
</script>
<script>
var init = function() {
	var lat = document.getElementById("latitude").value;
	var lng = document.getElementById("longitude").value;
    var center = new qq.maps.LatLng(lat,lng);
    map = new qq.maps.Map(document.getElementById('container'),{
        center: center,
        zoom: 13
    });
    geocoder = new qq.maps.Geocoder({
        complete : function(result){
            map.setCenter(result.detail.location);
			var place = result.detail.address;
			var desc = result.detail.addressComponents.street;
			document.getElementById("place").value = place;
			document.getElementById("desc").value = desc;
			postSubmit01();
			
        }
    });
}
function codeLatLng() {	
    var lat = document.getElementById("latitude").value;
    var lng = document.getElementById("longitude").value;
    var latLng = new qq.maps.LatLng(lat, lng);
    var info = new qq.maps.InfoWindow({map: map});
	//alert(info);
    geocoder.getAddress(latLng);
}
</script>
<script>
	dd.config({
		appId: '',
		corpId: '{lanrain:$jsssdk_info.corpId}',
		timeStamp: '{lanrain:$jsssdk_info.timeStamp}',
		nonceStr: '{lanrain:$jsssdk_info.nonceStr}',
		signature: '{lanrain:$jsssdk_info.signature}',
		jsApiList: ['runtime.info',
			'biz.contact.choose',
			'device.notification.confirm',
			'device.notification.alert',
			'device.notification.prompt',
			'biz.ding.post',
			'biz.util.uploadImage',
			'biz.util.previewImage',
			'biz.telephone.call',
			'device.geolocation.get',
			'biz.util.share']
	});
	dd.runtime.info({
		onSuccess: function(result) {
		/*{
			ability: '0.0.2' //容器版本，用来标识JSAPI能力，可根据该版本来决定能否使用jsapi
		}*/alert(result.ability)
		}
	});

	dd.error(function(error){
		alert(JSON.stringify(error));
	});
	dd.ready(function(){
		$('#submitImging').click(function(){
			dd.biz.util.uploadImage({
				multiple: false, //是否多选，默认false
				max: 3, //最多可选个数 0.0.3
				onSuccess : function(result) {
					photo = document.getElementById('pic').value;
					photo = photo + result[0] + ',';
					document.getElementById('pic').value = photo;	
					getLocation();	
				},
				onFail : function() {}
			})
		});	
    });	
</script>
<script>
function accAdd(arg1, arg2) {
      var r1, r2, m, c;
     try {
         r1 = arg1.toString().split(".")[1].length;
     }
     catch (e) {
         r1 = 0;
     }
     try {
         r2 = arg2.toString().split(".")[1].length;
     }
     catch (e) {
        r2 = 0;
     }
     c = Math.abs(r1 - r2);     
	 m = Math.pow(10, Math.max(r1, r2));
     if (c > 0) {
         var cm = Math.pow(10, c);
         if (r1 > r2) {
             arg1 = Number(arg1.toString().replace(".", ""));             
			 arg2 = Number(arg2.toString().replace(".", "")) * cm;
         } else {
             arg1 = Number(arg1.toString().replace(".", "")) * cm;
             arg2 = Number(arg2.toString().replace(".", ""));         
		}
     } else {
         arg1 = Number(arg1.toString().replace(".", ""));         
		 arg2 = Number(arg2.toString().replace(".", ""));
     }
     return (arg1 + arg2) / m;
 }
  function accSub(arg1, arg2) {
     var r1, r2, m, n;
     try {
         r1 = arg1.toString().split(".")[1].length;
     }
     catch (e) {
         r1 = 0;
     }
     try {
         r2 = arg2.toString().split(".")[1].length;
     }
     catch (e) {
         r2 = 0;
     }
     m = Math.pow(10, Math.max(r1, r2)); //last modify by deeka //动态控制精度长度
     n = (r1 >= r2) ? r1 : r2;
     return ((arg1 * m - arg2 * m) / m).toFixed(n);
 }
    function getLocation(){
		dd.device.geolocation.get({
			onSuccess : function(result) {
				latitude = accSub(result.latitude,0.00265);
				longitude = accAdd(result.longitude,0.0053);
				document.getElementById("longitude").value = longitude;
				document.getElementById("latitude").value =	latitude;
                codeLatLng();
				//postSubmit01();				
			},
			onFail : function(err) {}
		});	
	}
</script>	
<!-- <script>
	wx.config({
		debug: false,
		appId: '{lanrain:$jsssdk_info.appId}',
		timestamp: {lanrain:$jsssdk_info.timestamp},
		nonceStr: '{lanrain:$jsssdk_info.nonceStr}',
		signature: '{lanrain:$jsssdk_info.signature}',
		jsApiList: [
			'getLocation',
			'chooseImage',
			'uploadImage',			
		]
	});
</script>
<script>
$('#submitImging').click(function(){
	wx.chooseImage({
		sourceType: ['camera'], // 指定来源是相机	
		success: function (res) {			
			var localId = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片			
			uploadImage(localId,'');			
		}
	});

function uploadImage(localIds){
var localId = localIds.pop();
	var token="{lanrain::$_GET['token']}";
	var wecha_id="{lanrain::$_GET['wecha_id']}";
	wx.uploadImage({
		localId: localId,
		isShowProgressTips: 1,
		success: function (res) {
			var serverId = res.serverId;
			photo = document.getElementById('pic').value;
			photo = photo + serverId + ',';
			document.getElementById('pic').value = photo;
			postSubmit001();
		}
	});

}
	
});
</script> -->
<!-- <script>
$('#submitImging...').click(function(){
	postSubmit001();
});
</script>
<script>
function postSubmit001(){
		wx.getLocation({
			type: 'wgs84', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
			success: function (res) {
				var latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
				var longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
				var speed = res.speed; // 速度，以米/每秒计
				var accuracy = res.accuracy; // 位置精度
				document.getElementById("longitude").value = longitude;
				document.getElementById("latitude").value =	latitude;
				codeLatLng();	
				
			}
		});		
}
</script> -->
<script>
function postSubmit01(){
				var pic = $('#pic').val();
				var desc = $('#desc').val();
				var place = $('#place').val();
				var longitude = $('#longitude').val();
				var latitude =	$('#latitude').val();				
				var subdata = 'pic='+pic+'&desc='+desc+'&longitude='+longitude+'&latitude='+latitude+'&place='+place+'&desc='+desc+'';			
				$.ajax({
					type: "post",  
					url:"{lanrain::U('wap_check_details',array('token'=>$_GET['token'],'uid'=>$_GET['uid'],'wecha_id'=>$_GET['wecha_id'],'id'=>$_GET['id'],'status'=>1))}",
					dataType:'json',
					data:subdata,
					success:function(a){
						if(a==1){
							alert('签到失败，不在时间内');
						}
						if(a==2){
							alert('签到成功');
							window.location.href="{lanrain::U('wap_check_details',array('token'=>$_GET['token'],'uid'=>$_GET['uid'],'wecha_id'=>$_GET['wecha_id'],'id'=>$_GET['id'],'status'=>1))}";
							document.onmousedown=click;
						
						}
						if(a == 3){
							alert('获取地理位置失败');
						}
						if(a==4){
							alert('签到失败');
						}
						if(a==5){
							alert('必须上传照片才能签到');
						}
					}
				});	
}

</script>
</body>
</html>