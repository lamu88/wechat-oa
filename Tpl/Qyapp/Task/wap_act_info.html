<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"/>
    <title>任务详情</title>
    <link rel="stylesheet" href="./Tpl/Qyapp/Task/css/info/style1.css">
    <link rel="stylesheet" href="./Tpl/Qyapp/Applyflow/css/date.css">
    <link rel="stylesheet" type="text/css" href="./Tpl/Qyapp/Applyflow/css/btm.css?v=<?php echo time();?>">	
</head>
<body class="bg1">
<section class="sec03-01">
    <a class="tou">
        <img <if condition="$users['pic']"><img src="{lanrain:$users['pic']}"><else/><img src="./Tpl/Qyapp/Applyflow/images/que.png"></if>
        <div class="message">创建人：{lanrain:$users['name']}  &nbsp;&nbsp;  部门：{lanrain:$users['department']}</div> 
    </a>
</section>
<section class="sec03-02">
    <section class="sec02-01">
    <ul class="task_info">
        <li style="height:auto;overflow:hidden;width:20%;padding-left:5% !important;">
            <i></i>
			<span class="tj_tt tj_lh">负责人</span>
			
			<div class="userlist">
			<div class="userpic"><img <if condition="$fuzeren['pic'] eq ''"><img src="./Tpl/Qyapp/Task/images/que.png" width="20px" height="20px" style="width:34px;height:34px;border-radius:50%;"><p>{lanrain:$fuzeren.name}</p><else/><img src="{lanrain:$fuzeren['pic']}" width="20px" height="20px" style="width:34px;height:34px;border-radius:50%;"><p>{lanrain:$fuzeren.name}</p></if></div>
			<span class="user_x"></span>
			</div>       
        </li>
		<li style="height:auto;overflow:hidden;width:75%;">
			<span class="tj_tt tj_lh">协作人</span>
			<div class="userwidth">
			<div class="userlist width">
			<volist name="xiezhuren" id="xz">
				<div class="userpic"><img <if condition="$xz['pic']"><img src="{lanrain:$xz['pic']}"><else/><img src="./Tpl/Qyapp/Task/images/que.png"></if><p>{lanrain:$xz.name}</p></div>
			</volist>
			</div>
			</div>       
        </li>
		<li>
            <i></i>
			<span class="item-span tj_tt">开始时间</span>
			<span class="span">{lanrain:$data.start_time|date="Y-m-d",###}</span>
        </li>
		<li>
            <i></i>
			<span class="item-span tj_tt">完成时间</span>
			<span class="span">{lanrain:$data.end_time|date="Y-m-d",###}</span>
        </li>
    </ul>
	<article>
        <div class="con">
            <div class="txt">
                {lanrain:$data.title}
                <p>{lanrain:$data.content}</p>
            </div>
            <div class="img">
                <volist name="pics" id="v" key="k">
					<img src="{lanrain:$v}" id="picInfo_{lanrain:$k}" width="36px" height="36px" onclick="checkImg({lanrain:$k});" />
				</volist>
                <div class="clear"></div>
            </div>
        </div>
    </article>
</section>
</section>
<section class="sec03-03" >
    <article style="margin:0;">
        <ul>
			<volist name="list" id="vo" k="key">
            <li>
                <div class="fl">
                    <div class="c"><if condition="$vo['info']['pic'] eq ''"><img src="./Tpl/Qyapp/Applyflow/images/que.png"><else/><img src="{lanrain:$vo.info.pic}"></if><span>{lanrain:$vo.info.name}</span></div>
                    <!-- <div class="c">{lanrain:$vo.posttime|date="Y-m-d H:i:s",###}</div> -->
                </div>
                <div class="fr">
                    <div class="t" style="font-size:12px;"><!-- <if condition="$vo['status'] eq '1'">讨论了此任务<else/>完成了此任务</if> -->{lanrain:$vo.posttime|date="Y-m-d H:i:s",###}
					</div>
                    <div class="c">{lanrain:$vo.content}</div>
					<div class="triangle"></div>
                </div>
                <div class="clear"></div>
            </li>
	        </volist>
            			
        </ul>
    </article>
</section>
<div class="sec03-bottom-top"></div>
    <!-- <if condition="$witer['status'] eq 0"> -->
	<div class="btm_comment" id="com2" <?php if($is_finish == 0){echo 'style="display:block"';}else{echo 'style="display:none"';}?>>
		<div class="comment_row" id="control">
			<div id="menu" style="margin-left:0px;margin-right:2px;">
				<ul style="margin:0 auto;list-style-type:none;width:100%;height:100%;padding-left: 0;">
				<?php if($checks == 0){?>
				<a href="javascript:;" id="jujue"><li style="float:left;background:#35aa47;width:100%;"><div class="menu_li" >讨论</div>
				</li></a>				
				<?php }else{?>
				<a href="javascript:;" id="jujue"><li style="float:left;background:#35aa47;";><div class="menu_li" >讨论</div>
				</li></a>				
				<a href="javascript:;" id="tongyi"><li style="float:right;background:#35aa47;"><div class="menu_li">完成任务</div></li></a>
				<?php }?>
				</ul>
			</div>
		</div>
		
		<div class="comment_row" style="display:none;" id="yes">
			<p style="text-align:left;padding-left:10px;float:left;">请输入讨论内容(非必填)</p>
			<p style="float:right;"><!-- 手写输入: --><!-- <span onclick="shurujujue()"><img src="Tpl/Qyapp/Applyflow/images/iconfont-shuru.png" width="24px" height="24px"> --><!-- <input type="radio" name="type" value="0" checked="checked"/> --></span><!-- &nbsp;&nbsp;<span onclick="yuyinjujue()"><img src="Tpl/Qyapp/Applyflow/images/sec03-07.png" width="24px" height="24px"></span> --></p>		
			<div class="write" id="jujie_write_comment">				
				<textarea class="enter_font" type="text" value="" class="newimg info" id="reason1" name="name" style="width: 98%;height: 75px;background-color: #fff;border: 1px solid #ccc;border-radius: 3px;color: #999;margin-top: 10px;margin-bottom:10px;"></textarea> 
			</div>
			<div class="write" id="jujie_voice_comment">

				<div class="page-container">
					<div class="title">长按说话</div>
					<div class="icon">
						<!-- <img src="Tpl/Qyapp/Applyflow/images/mouth.png" class="mouth img_mouth"> -->
						<a href="javascript:;" id="record"><img src="Tpl/Qyapp/Applyflow/images/sec03-10.png" width="80px" height="80px" class="mouth img_mouth"></a>
						<a class="play img_play" href="javascript:playRecord()" style="display:none"><img src="Tpl/Qyapp/Applyflow/images/play.png"></a>
						<!-- <img src="Tpl/Qyapp/Applyflow/images/playVoice.gif" class="playgif img_recording" style="display:none"> -->
						<img src="Tpl/Qyapp/Applyflow/images/iconfont-yuyinshiting.png" class="playgif img_recording" style="display:none">
					</div>
					<!-- <div class="tips div_tips" >&nbsp;</div> -->
					<!-- <div class="btn">
						<a href="javascript:restartRecord()" class="gray div_start" style="font-size: 12px;color: #222;">开始录音</a>
						<a class="green div_stop" href="javascript:stopRecord()" style="display:none">停止录音</a>
					</div>
					<div class="bottomtext div_friendtxt" style="display:none">已保存，可分享</div> -->
				</div>
			
				<input type="hidden" name="jujie_voice">  
			</div>			
			<div id="menu" style="margin-left:0px;margin-right:2px;">
				<ul style="margin:0 auto;list-style-type:none;width:100%;height:100%;padding-left: 0;">
				<a href="javascript:;" id="fanhui1"><li style="float:left;background:#de5045;"><div class="menu_li" >返回</div>
				</li></a>
				<a href="javascript:;" id="queding1"><li style="float:right;background:#35aa47;"><div class="menu_li" >确定</div>
				</li></a> 				
								
				</ul>
			</div>
		</div>	
		<div class="comment_row" style="display:none;height:20px;line-height:20px;" id="no">
		     <!-- <span style="text-align:left;padding-left:10px;float:left;">审批意见:</span> -->
			 请输入审批意见(非必填)
			 <span style="float:right;"><!-- 请选择：<span onclick="shurutongyi()"><img src="Tpl/Qyapp/Applyflow/images/iconfont-shuru.png" width="22px" height="22px"></span> --><!-- &nbsp;&nbsp;<span onclick="yuyintongyi()"><img src="Tpl/Qyapp/Applyflow/images/sec03-07.png" width="22px" height="22px"></span> --></span>
			<div class="write" id="tongyi_write_comment">
				<textarea class="enter_font" type="text" value="" class="newimg info" id="reason2" name="name" style="width: 98%;height: 75px;background-color: #fff;border: 1px solid #ccc;border-radius: 3px;color: #999;margin-top: 10px;margin-bottom:10px;"></textarea> 
			</div>
			<div class="write" id="tongyi_voice_comment">
			
					<div class="page-container">
						<!-- <div class="title">录制语音</div> -->
						<div class="icon">
							<img src="Tpl/Qyapp/Applyflow/images/sec03-10.png" width="80px" height="80px" class="mouth img_mouth">
							<a class="play img_play" href="javascript:playRecord()" style="display:none"><img src="Tpl/Qyapp/Applyflow/images/iconfont-yuyinshiting.png"><!-- <img src="Tpl/Qyapp/Applyflow/images/play.png"> --></a>
							<img src="Tpl/Qyapp/Applyflow/images/playVoice.gif" class="playgif img_recording" style="display:none">
						</div>
						<!-- <div class="tips div_tips" >&nbsp;</div> -->
						<div class="btn">
							<a href="javascript:restartRecord()" class="gray div_start" style="font-size: 12px;color: #222;">开始录音</a>
							<a class="green div_stop" href="javascript:stopRecord()" style="display:none">停止录音</a>
                        </div>
						<div class="bottomtext div_friendtxt" style="display:none">已保存，可分享</div>
					</div>  
					
				<input type="hidden" name="tongyi_voice"> 
			</div>			
			<div id="menu" style="margin-left:0px;margin-right:2px;">
				<ul style="margin:0 auto;list-style-type:none;width:100%;height:100%;padding-left: 0;">
				<a href="javascript:;" id="fanhui2"><li style="float:left;background:#de5045;"><div class="menu_li" >返回</div>
				</li></a>
				<a href="javascript:;" id="queding2"><li style="float:right;background:#35aa47;"><div class="menu_li" >确定</div>
				</li></a> 				
								
				</ul>
			</div>
		</div>		
	</div>
	<style>
	#menu{position:fixed;bottom:0px;width:95%;height:36px;line-height:36px;background:#fff;z-index:999;margin-left:3%;padding-bottom: 10px;}
	#menu ul li{float:left;width:49%;height:100%;text-align:center;position:relative;font-size:14px;border-radius: 3px;}
	#menu ul li .menu_li{position:absolute;top:0px;left:0px;z-index:20;width:100%;height:100%;color:#fff;}
	a{text-decoration:none;}
	</style>
	<input type="text" id="txt_serverID" style="display:none" />
	<input type="text" id="myvoice" name="voice" style="display:none" />
    <input type="hidden" id="token" value="<?php echo $_GET['token']?>"></input>
	<script src="./Tpl/static/scroll/dev/jquery-1.9.1.js"></script>	
<script src="./Tpl/Qyapp/Applyflow/js/jquery.js"></script>
<script src="./Tpl/Qyapp/Applyflow/js/main.js"></script>
<script>
$('#jujie_voice_comment').css('display','none');
$('#tongyi_voice_comment').css('display','none');
$('.btm_comment').css('height','55px');
$('#jujue').on('click',function(){
$('.btm_comment').css('height','180px');
$('#jujie_write_comment').css('display','block');
$('#control').css('display','none');
$('#yes').css('display','block');
$('#no').css('display','none');
});
$('#tongyi').on('click',function(){
$('.btm_comment').css('height','180px');
$('#tongyi_write_comment').css('display','block');
$('#control').css('display','none');
$('#yes').css('display','none');
$('#no').css('display','block');
});
$('#fanhui1').on('click',function(){
$('.btm_comment').css('height','55px');
$('#control').css('display','block');
$('#yes').css('display','none');
$('#no').css('display','none');
});
$('#fanhui2').on('click',function(){
$('.btm_comment').css('height','55px');
$('#control').css('display','block');
$('#yes').css('display','none');
$('#no').css('display','none');
});
</script>
<script>
function shurujujue(){
   $('#jujie_write_comment').css('display','block');
   $('#jujie_voice_comment').css('display','none');
   $('.btm_comment').css('height','180px');
}
function yuyinjujue(){

    $('#jujie_write_comment').css('display','none');
   $('#jujie_voice_comment').css('display','block');
   $('.btm_comment').css('height','180px');
}
function shurutongyi(){
    $('#tongyi_write_comment').css('display','block');
    $('#tongyi_voice_comment').css('display','none');
	$('.btm_comment').css('height','180px');
}
function yuyintongyi(){
    $('#tongyi_write_comment').css('display','none');
    $('#tongyi_voice_comment').css('display','block');
	$('.btm_comment').css('height','180px');
}
</script>
<script src="http://g.alicdn.com/ilw/ding/0.2.7/scripts/dingtalk.js"></script>

<script>
//同意
$('#queding2').click(function(){
    var content = $('#reason2').val();
	var voice = '';
    if($('#myvoice').val()){
	    voice = $('#myvoice').val();
	}	
	var id = "{lanrain::$_GET['id']}";
	$.ajax({
			type: "post",  
			url:"{lanrain::U('finish',array('token'=>$_GET['token'],'wecha_id'=>$_GET['wecha_id'],'id'=>$_GET['id']))}",
			data:{'content':content,'voice':voice},
			dataType:'json',
			//data:{'token':token,'wecha_id':wecha_id,'id':id,'status':status},
			success:function(json){
				alertsuccess(json.errmsg);
				//if(json.status == 1){
					window.location.reload();
				//}
			},error:function(){
				window.location.reload();
			}
		});
});

//拒绝
$('#queding1').click(function(){
    var content = $('#reason1').val();
	var voice = '';
    if($('#myvoice').val()){
	    voice = $('#myvoice').val();
	}	
	var id = "{lanrain::$_GET['id']}";
	//return false;
	$.ajax({
			type: "post",  
			url:"{lanrain::U('wap_act_discuz',array('token'=>$_GET['token'],'wecha_id'=>$_GET['wecha_id'],'id'=>$_GET['id']))}",
			data:{'content':content,'voice':voice},			
			dataType:'json',
			//data:{'token':token,'wecha_id':wecha_id,'id':id,'status':status},
			success:function(json){
				alertsuccess(json.errmsg);
				//if(json.status == 1){
					window.location.reload();
				//}
			}
		});
});

function alertsuccess(msg){
	dd.ready(function(){
		dd.device.notification.toast({
			icon: 'success', //icon样式，有success和error，默认为空 0.0.2
			text: msg, //提示信息
			duration: '2', //显示持续时间，单位秒，默认按系统规范[android只有两种(<=2s >2s)]
			delay: '0', //延迟显示，单位秒，默认0
			onSuccess : function(result) {
				/*{}*/
			},
			onFail : function(err) {}
		})
	});
}
function alerterror(msg){
	dd.ready(function(){
		dd.device.notification.toast({
			icon: 'error', //icon样式，有success和error，默认为空 0.0.2
			text: msg, //提示信息
			duration: '2', //显示持续时间，单位秒，默认按系统规范[android只有两种(<=2s >2s)]
			delay: '0', //延迟显示，单位秒，默认0
			onSuccess : function(result) {
				/*{}*/
			},
			onFail : function(err) {}
		})
	});
}
//取消
function closeLay(){
window.location.reload();
}
//发送理由
function submitLay(m,n){
	var token = "{lanrain::$_GET['token']}";
	var wecha_id = "{lanrain::$_GET['wecha_id']}";
	var content = $('#layContent').val();
	$.ajax({
		type: "post",  
		url:"{lanrain::U('wap_comment',array('token'=>$_GET['token'],'wecha_id'=>$_GET['wecha_id']))}",
		dataType:'json',
		data:{'token':token,'wecha_id':wecha_id,'id':m,'status':n,'content':content},
		success:function(json){
			if(json==1){
				alert('修改成功');
				window.location.reload();
			}
			if(json==2){
				alert('修改失败');
				window.location.reload();
			}
			if(json==3){
				alert('发表成功');
				window.location.reload();
			}
			if(json==4){
				alert('发表失败');
				window.location.reload();
			}
		}
	});
}
</script>
<script type="text/javascript">

    //var play_time_ti;
    var is_playing = false;
    function playVoice(id) {
        is_playing = true;
        //play_time_ti = setInterval(function () {
        //    var tt = $('.div_tips').text().replace("s", "");
        //    var ss = tt * 1;
        //    $('.div_tips').text((ss > 1 ? ss - 1 : 0) + "s");
        //}, 1000);

        setTimeout(function () {
            is_playing = false;
            $(".img_recording").hide();
            $('.img_play').show();
            //$('.div_tips').text(voice_record_time * 1 + "s");

            //if (play_time_ti) {
           //     clearInterval(play_time_ti);
            //}

        }, voice_record_time * 1000);
        wx.playVoice({
            localId: id// 需要播放的音频的本地ID，由stopRecord接口获得
        });

    }

    function playVoiceByUser() {
        if (is_playing) return;

        playVoice(last_voice_localId);
    }
    function uploadVoice(localId) {
	    //alert(localId);
        wx.uploadVoice({
            localId: localId, // 需要上传的音频的本地ID，由stopRecord接口获得
            isShowProgressTips: 1, // 默认为1，显示进度提示
            success: function (res) {
                var serverId = res.serverId; // 返回音频的服务器端ID
                $("#txt_serverID").val(serverId);
				$("#myvoice").val(serverId);
				//alert($("#myvoice").val());
                //$("#div_friend").show();
                //$("#div_friendtxt").show();
				//wxShareDataArray[3] = serverId;
                //changeWeixinShareData();
            }
        });
    }

    var last_voice_localId;
    function onRecordDone(localId) {

        voice_record_time = Math.ceil(((new Date()).getTime() - voice_record_start) / 1000);
		//alert(voice_record_time+'aa');
        //$(".div_tips").text(voice_record_time * 1 + "s");
        last_voice_localId = localId;
		//alert(last_voice_localId+'bbbs');
        //wxShareDataArray[2] = voice_record_time * 1 + "\"";
        setTimeout(function () {
            uploadVoice(localId);
        }, 1000);

        playVoice(localId);

    }

    var isRecording = false;
    function startRecord() {
        if (isRecording) return;
        $(".img_mouth").hide();
        $(".div_start").hide();
        $('.img_play').hide();
        $(".img_recording").show();
        //$(".div_tips").show();
        //$(".div_tips").text("正在录音...");
        $(".div_stop").show();
        $(".div_friend").hide();
        $(".div_friendtxt").hide();
        isRecording = true;
        wx.onVoiceRecordEnd({
            // 录音时间超过一分钟没有停止的时候会执行 complete 回调
            complete: function (res) {
                var localId = res.localId;

                isRecording = false;
                onRecordDone(localId);
            }
        });


        voice_record_time = 0;
        voice_record_start = (new Date()).getTime();

        wx.startRecord({
            success: function () {
                isRecording = false;
                voice_record_start = (new Date()).getTime();
            },
            cancel: function () {
                isRecording = false;
            }
        });

    }


    function stopRecord() {
        isRecording = false;
		$('.img_recording').show();
		$('.img_play').show();
        //$(".div_stop").hide();
        $(".div_start").show();
        wx.stopRecord({
            success: function (res) {
                var localId = res.localId;
				//alert(localId);
                onRecordDone(localId);
				$('.img_recording').show();
				$('.img_play').show();
            }
        });
        //$(".img_recording").show();
        //$(".div_tips").show();
        //$(".div_tips").text("正在录音...");
        //$(".div_stop").show();		
		$('.img_recording').show();
		$('.img_play').show();		
    }

    function playRecord() {
        $(".img_recording").show();
        $('.img_play').hide();
        playVoice(last_voice_localId);
    }

    function restartRecord() {
        startRecord();
    }
	$('#record').mousedown(function(){
	    alert('aaa');
	});
	$('#record').mousedown(function(){
	    alert('bbb');
	});	
</script>
</body>
</html>